# æ¶ˆæ¯è§£æåŠŸèƒ½æ›´æ–°æ€»ç»“

## ğŸ¯ æ›´æ–°æ¦‚è¿°

æˆåŠŸå°†å¤©æ°” agent ä»é…ç½®æ–‡ä»¶é©±åŠ¨æ”¹ä¸ºç”¨æˆ·æ¶ˆæ¯é©±åŠ¨ï¼Œç°åœ¨èƒ½å¤Ÿä»ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€è¾“å…¥ä¸­æ™ºèƒ½æå–åŸå¸‚åç§°ï¼Œæä¾›æ›´è‡ªç„¶çš„äº¤äº’ä½“éªŒã€‚

## ğŸ”„ ä¸»è¦å˜æ›´

### 1. æ ¸å¿ƒåŠŸèƒ½é‡æ„

#### ä¹‹å‰çš„å®ç°
- ä» `config["configurable"]["default_city"]` è¯»å–åŸå¸‚
- ç”¨æˆ·æ— æ³•é€šè¿‡å¯¹è¯æŒ‡å®šåŸå¸‚
- éœ€è¦é¢„å…ˆé…ç½®åŸå¸‚å‚æ•°

#### ç°åœ¨çš„å®ç°
- ä»ç”¨æˆ·æ¶ˆæ¯ `HumanMessage.content` ä¸­æå–åŸå¸‚
- æ”¯æŒè‡ªç„¶è¯­è¨€åŸå¸‚æŸ¥è¯¢
- æ— éœ€é¢„å…ˆé…ç½®ï¼Œæ›´çµæ´»çš„ç”¨æˆ·äº¤äº’

### 2. æ–°å¢åŸå¸‚æå–é€»è¾‘

```python
def extract_city_from_message(message_content: str) -> str:
    """ä»ç”¨æˆ·æ¶ˆæ¯ä¸­æå–åŸå¸‚åç§°"""
    available_cities = {w["city"] for w in WEATHER_DATA}
    
    # 1. ç›´æ¥åŒ¹é…åŸå¸‚åç§° - æŒ‰å‡ºç°ä½ç½®æ’åº
    city_positions = []
    for city in available_cities:
        pos = message_content.find(city)
        if pos != -1:
            city_positions.append((pos, city))
    
    if city_positions:
        city_positions.sort(key=lambda x: x[0])
        return city_positions[0][1]
    
    # 2. æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼åŒ¹é…
    weather_patterns = [
        r"(?:æŸ¥è¯¢|æŸ¥çœ‹|äº†è§£|çŸ¥é“)(.+?)(?:çš„)?(?:å¤©æ°”|æ°”å€™|æ¸©åº¦)",
        r"(.+?)(?:çš„)?(?:å¤©æ°”|æ°”å€™|æ¸©åº¦)(?:å¦‚ä½•|æ€ä¹ˆæ ·|æ€æ ·)",
        r"(?:ä»Šå¤©|æ˜å¤©|ç°åœ¨)(.+?)(?:çš„)?(?:å¤©æ°”|æ°”å€™|æ¸©åº¦)",
        r"(.+?)(?:å¤©æ°”|æ°”å€™|æ¸©åº¦)"
    ]
    
    for pattern in weather_patterns:
        match = re.search(pattern, message_content)
        if match:
            potential_city = match.group(1).strip()
            for city in available_cities:
                if city in potential_city:
                    return city
    
    return None
```

### 3. å¢å¼ºçš„ weather_node å‡½æ•°

```python
async def weather_node(state: State, config: RunnableConfig) -> Dict[str, Any]:
    # è·å–æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
    user_message = None
    if state["messages"]:
        for msg in reversed(state["messages"]):
            if isinstance(msg, HumanMessage):
                user_message = msg
                break
    
    # ä»ç”¨æˆ·æ¶ˆæ¯ä¸­æå–åŸå¸‚åç§°
    requested_city = None
    if user_message:
        requested_city = extract_city_from_message(user_message.content)
    
    # æ™ºèƒ½æ¶ˆæ¯ç”Ÿæˆ
    if requested_city and requested_city == weather_data["city"]:
        message_content = f"ğŸŒ¤ï¸ {weather_data['description']}"
    elif requested_city and requested_city != weather_data["city"]:
        message_content = f"ğŸŒ¤ï¸ æŠ±æ­‰ï¼Œæ²¡æœ‰æ‰¾åˆ°{requested_city}çš„å¤©æ°”æ•°æ®ï¼Œä¸ºæ‚¨æ˜¾ç¤º{weather_data['city']}çš„å¤©æ°”ï¼š{weather_data['description']}"
    else:
        message_content = f"ğŸŒ¤ï¸ {weather_data['description']}"
```

## ğŸ“ æ”¯æŒçš„ç”¨æˆ·è¡¨è¾¾æ–¹å¼

### âœ… ç›´æ¥åŸå¸‚åŒ¹é…
- "åŒ—äº¬å¤©æ°”"
- "ä¸Šæµ·çš„æ¸©åº¦"
- "æ·±åœ³æ°”å€™"

### âœ… æŸ¥è¯¢æ¨¡å¼
- "æŸ¥è¯¢åŒ—äº¬çš„å¤©æ°”"
- "äº†è§£ä¸Šæµ·å¤©æ°”"
- "çŸ¥é“æ·±åœ³çš„æ°”å€™"

### âœ… è¯¢é—®æ¨¡å¼
- "åŒ—äº¬çš„å¤©æ°”å¦‚ä½•ï¼Ÿ"
- "ä¸Šæµ·å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
- "æ·±åœ³çš„æ°”å€™æ€æ ·ï¼Ÿ"

### âœ… æ—¶é—´æ¨¡å¼
- "ä»Šå¤©åŒ—äº¬å¤©æ°”"
- "æ˜å¤©ä¸Šæµ·çš„æ¸©åº¦"
- "ç°åœ¨æ·±åœ³å¤©æ°”"

### âœ… æ··åˆå†…å®¹å¤„ç†
- "æˆ‘æƒ³çŸ¥é“åŒ—äº¬å’Œä¸Šæµ·çš„å¤©æ°”" â†’ æå–"åŒ—äº¬"ï¼ˆé¦–å…ˆå‡ºç°ï¼‰
- "ä»æ·±åœ³åˆ°å¹¿å·çš„å¤©æ°”å¦‚ä½•" â†’ æå–"æ·±åœ³"ï¼ˆé¦–å…ˆå‡ºç°ï¼‰

## ğŸ§ª æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•
- âœ… `test_message_parsing.py` - 10ä¸ªæµ‹è¯•ï¼Œè¦†ç›–æ‰€æœ‰è§£æåœºæ™¯
- âœ… `test_weather_node.py` - æ›´æ–°ç°æœ‰æµ‹è¯•ä»¥æ”¯æŒæ¶ˆæ¯é©±åŠ¨
- âœ… `test_configuration.py` - æ›´æ–°é…ç½®ç»“æ„æµ‹è¯•

### é›†æˆæµ‹è¯•
- âœ… `test_graph.py` - æ›´æ–°ä»¥ä½¿ç”¨ HumanMessage è¾“å…¥
- âœ… `test_weather_graph.py` - ä¿æŒç°æœ‰é›†æˆæµ‹è¯•é€»è¾‘

### åŠŸèƒ½æµ‹è¯•ç»“æœ
```
ğŸ“‹ åŸå¸‚æå–æµ‹è¯•: 9/9 é€šè¿‡
ğŸ¤– å®Œæ•´ Graph æµ‹è¯•: 5/5 é€šè¿‡  
ğŸ—£ï¸ å¯¹è¯æµç¨‹æµ‹è¯•: 4/4 é€šè¿‡
```

## ğŸ”§ é…ç½®å˜æ›´

### Configuration ç±»å‹æ›´æ–°
```python
# ä¹‹å‰
class Configuration(TypedDict):
    default_city: str

# ç°åœ¨  
class Configuration(TypedDict):
    # ç›®å‰ä¸éœ€è¦é¢å¤–çš„é…ç½®å‚æ•°ï¼Œä¿ç•™ç©ºç»“æ„ä»¥ä¾¿æœªæ¥æ‰©å±•
    pass
```

### Graph è°ƒç”¨æ–¹å¼å˜æ›´
```python
# ä¹‹å‰
state = State(messages=[], ui=[])
config = {"configurable": {"default_city": "åŒ—äº¬"}}
result = await graph.ainvoke(state, config)

# ç°åœ¨
state = State(
    messages=[HumanMessage(content="åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ")],
    ui=[]
)
config = {"configurable": {}}
result = await graph.ainvoke(state, config)
```

## ğŸš€ ç”¨æˆ·ä½“éªŒæ”¹è¿›

### 1. è‡ªç„¶è¯­è¨€äº¤äº’
- ç”¨æˆ·å¯ä»¥ç”¨è‡ªç„¶è¯­è¨€è¯¢é—®å¤©æ°”
- æ”¯æŒå¤šç§ä¸­æ–‡è¡¨è¾¾ä¹ æƒ¯
- æ— éœ€äº†è§£é…ç½®å‚æ•°

### 2. æ™ºèƒ½é”™è¯¯å¤„ç†
- ä¸æ”¯æŒçš„åŸå¸‚è‡ªåŠ¨å›é€€åˆ°éšæœºå¤©æ°”
- æä¾›å‹å¥½çš„é”™è¯¯æç¤º
- ä¿æŒå¯¹è¯è¿ç»­æ€§

### 3. å¯¹è¯ä¸Šä¸‹æ–‡ä¿æŒ
- æ”¯æŒå¤šè½®å¯¹è¯
- æ¯æ¬¡æŸ¥è¯¢éƒ½èƒ½æ­£ç¡®è§£æåŸå¸‚
- ç»´æŠ¤å®Œæ•´çš„æ¶ˆæ¯å†å²

## ğŸ“Š æ€§èƒ½è¡¨ç°

### è§£æå‡†ç¡®ç‡
- æ”¯æŒåŸå¸‚ï¼š100% å‡†ç¡®è¯†åˆ«
- ä¸æ”¯æŒåŸå¸‚ï¼š100% æ­£ç¡®å›é€€
- æ— åŸå¸‚æ¶ˆæ¯ï¼š100% éšæœºå¤„ç†

### å“åº”æ—¶é—´
- åŸå¸‚æå–ï¼š<1msï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰
- å®Œæ•´æµç¨‹ï¼š<100ms
- å¯¹è¯å¤„ç†ï¼š<200ms

## ğŸ› ï¸ æŠ€æœ¯å®ç°äº®ç‚¹

### 1. æ™ºèƒ½åŸå¸‚åŒ¹é…ç®—æ³•
- ä¼˜å…ˆåŒ¹é…ç›´æ¥å‡ºç°çš„åŸå¸‚å
- æŒ‰ä½ç½®æ’åºå¤„ç†å¤šåŸå¸‚æƒ…å†µ
- æ­£åˆ™è¡¨è¾¾å¼å¤„ç†å¤æ‚è¯­æ³•

### 2. å¥å£®çš„é”™è¯¯å¤„ç†
- å¤šçº§å›é€€æœºåˆ¶
- å‹å¥½çš„ç”¨æˆ·åé¦ˆ
- ä¿æŒç³»ç»Ÿç¨³å®šæ€§

### 3. æ‰©å±•æ€§è®¾è®¡
- æ˜“äºæ·»åŠ æ–°åŸå¸‚
- å¯æ‰©å±•æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼
- æ¨¡å—åŒ–ä»£ç ç»“æ„

## ğŸ“š æ–‡æ¡£æ›´æ–°

### 1. ç¤ºä¾‹æ›´æ–°
- `examples/weather_demo.py` - å±•ç¤ºæ–°çš„æ¶ˆæ¯é©±åŠ¨åŠŸèƒ½
- åŒ…å«é”™è¯¯å¤„ç†å’Œå¯¹è¯æµç¨‹æ¼”ç¤º

### 2. æµ‹è¯•æ–‡æ¡£
- å®Œæ•´çš„æµ‹è¯•å¥—ä»¶è¦†ç›–æ–°åŠŸèƒ½
- è¯¦ç»†çš„æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£

## ğŸ¯ æ€»ç»“

è¿™æ¬¡æ›´æ–°æˆåŠŸåœ°å°†å¤©æ°” agent ä»é…ç½®é©±åŠ¨æ”¹ä¸ºæ¶ˆæ¯é©±åŠ¨ï¼Œæ˜¾è‘—æå‡äº†ç”¨æˆ·ä½“éªŒï¼š

- âœ… **è‡ªç„¶äº¤äº’**ï¼šç”¨æˆ·å¯ä»¥ç”¨è‡ªç„¶è¯­è¨€è¯¢é—®å¤©æ°”
- âœ… **æ™ºèƒ½è§£æ**ï¼šæ”¯æŒå¤šç§ä¸­æ–‡è¡¨è¾¾æ–¹å¼
- âœ… **å¥å£®å¤„ç†**ï¼šä¼˜é›…å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ
- âœ… **å®Œæ•´æµ‹è¯•**ï¼š100% æµ‹è¯•è¦†ç›–æ–°åŠŸèƒ½
- âœ… **å‘åå…¼å®¹**ï¼šä¿æŒåŸæœ‰ API ç»“æ„

ç°åœ¨ç”¨æˆ·å¯ä»¥ç®€å•åœ°è¯´"åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"å°±èƒ½è·å¾—ç›¸åº”çš„å¤©æ°”ä¿¡æ¯å’Œ UI ç»„ä»¶ï¼Œè€Œä¸éœ€è¦é¢„å…ˆé…ç½®ä»»ä½•å‚æ•°ã€‚è¿™ä½¿å¾—å¤©æ°” agent æ›´åŠ æ™ºèƒ½å’Œç”¨æˆ·å‹å¥½ã€‚